Обмен между потоками. Класс Exchanger

Класс Exchanger предназначен для обмена данными между потоками. Он является типизированным и типизируется типом данных, которыми потоки должны обмениваться.

Обмен данными производится с помощью единственного метода этого класса exchange():

1
2
V exchange(V x) throws InterruptedException
V exchange(V x, long timeout, TimeUnit unit) throws InterruptedException, TimeoutException
Параметр x представляет буфер данных для обмена. Вторая форма метода также определяет параметр timeout - время ожидания и unit - тип временных единиц, применяемых для параметра timeout.

Данный класс очень просто использовать:

1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
import java.util.concurrent.Exchanger;
  
public class Program {
  
    public static void main(String[] args) {
          
        Exchanger<String> ex = new Exchanger<String>();
        new Thread(new PutThread(ex)).start();
        new Thread(new GetThread(ex)).start();
    }
}
  
class PutThread implements Runnable{
      
    Exchanger<String> exchanger;
    String message;
  
    PutThread(Exchanger<String> ex){
          
        this.exchanger=ex;
        message = "Hello Java!";
    }
    public void run(){
          
        try{
            message=exchanger.exchange(message);
            System.out.println("PutThread has received: " + message);
        }
        catch(InterruptedException ex){
            System.out.println(ex.getMessage());
        }
    }
} 
class GetThread implements Runnable{
      
    Exchanger<String> exchanger;
    String message;
  
    GetThread(Exchanger<String> ex){
          
        this.exchanger=ex;
        message = "Hello World!";
    }
    public void run(){
          
        try{
            message=exchanger.exchange(message);
            System.out.println("GetThread has received: " + message);
        }
        catch(InterruptedException ex){
            System.out.println(ex.getMessage());
        }
    }
} 
В классе PutThread отправляет в буфер сообщение "Hello Java!":

1
message=exchanger.exchange(message);
Причем в ответ метод exchange возвращает данные, которые отправил в буфер другой поток. То есть происходит обмен данными. Хотя нам необязательно получать данные, мы можем просто их отправить:

1
exchanger.exchange(message);
Логика класса GetThread аналогична - также отправляется сообщение.

В итоге консоль выведет следующий результат:

PutThread has received: Hello World!
GetThread has received: Hello Java!